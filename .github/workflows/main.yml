name: CI/CD Complete Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # --- ÉTAPE 1 : BUILD & TEST ---
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      # Vérification simple que le code est syntaxiquement correct
      - name: Basic Health Check
        run: node -e "console.log('Syntaxe du code OK')"

  # --- ÉTAPE 2 : SÉCURITÉ SAST (CodeQL) ---
  security-sast:
    needs: build-and-test
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # --- ÉTAPE 3 : SÉCURITÉ DAST (OWASP ZAP) ---
  security-dast:
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies & Start App
        run: |
          npm install
          # Démarrage en arrière-plan
          npm start &
          
          # ATTENTE INTELLIGENTE (Fix Connection Refused)
          # On attend que le port 3000 réponde
          echo "Waiting for server to be available..."
          npx wait-on http://localhost:3000 --timeout 60000

      - name: Run OWASP ZAP Scan
        run: |
          # FIX: Image 'zaproxy/zap-stable' + option '-u 0' (root) pour les permissions
          docker run --network host -u 0 \
            -v $(pwd):/zap/wrk/:rw \
            -t zaproxy/zap-stable zap-baseline.py \
            -t http://localhost:3000 \
            -r zap_report.html \
            -I

      - name: Upload ZAP Report
        if: always() # Télécharger le rapport même si des failles sont trouvées
        uses: actions/upload-artifact@v4
        with:
          name: zap-security-report
          path: zap_report.html

  # --- ÉTAPE 4 : DOCKER BUILD & PUSH ---
  docker-publish:
    needs: [build-and-test, security-sast]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ghayth
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # Ton image sera ici :
          tags: ghayth/devops-project:latest