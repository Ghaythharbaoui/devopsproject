name: CI/CD Complete Pipeline

# Déclencheurs : Push sur main ou Pull Requests
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # --- ÉTAPE 1 : BUILD & TEST ---
  # Objectif : Vérifier que le code s'installe et se lance correctement [cite: 10, 40]
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Installation des dépendances
        run: npm install

      # Si tu as des tests unitaires (Jest/Mocha), c'est ici qu'ils s'exécutent
      # Pour l'instant, on vérifie juste la syntaxe
      - name: Test basique (Health Check)
        run: |
          node -e "console.log('Syntaxe du code OK')"

  # --- ÉTAPE 2 : SÉCURITÉ SAST (Statique) ---
  # Objectif : Scanner le code source pour trouver des failles [cite: 17, 29]
  security-sast:
    needs: build-and-test
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Initialisation CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Analyse du code
        uses: github/codeql-action/analyze@v3

  # --- ÉTAPE 3 : SÉCURITÉ DAST (Dynamique) ---
  # Objectif : Lancer l'app et l'attaquer avec OWASP ZAP [cite: 17, 29]
  security-dast:
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup et Démarrage App
        run: |
          npm install
          # Lancement en arrière-plan (&)
          npm start &
          echo "Attente du démarrage du serveur..."
          sleep 10

      - name: Run OWASP ZAP Scan
        run: |
          # Correction : Utilisation de la nouvelle image 'zaproxy/zap-stable'
          docker run --network host \
            -v $(pwd):/zap/wrk/:rw \
            -t zaproxy/zap-stable zap-baseline.py \
            -t http://localhost:3000 \
            -r zap_report.html \
            -I

      - name: Sauvegarder le rapport DAST
        uses: actions/upload-artifact@v4
        with:
          name: zap-security-report
          path: zap_report.html

  # --- ÉTAPE 4 : DOCKER BUILD & PUSH ---
  # Objectif : Créer l'image et l'envoyer sur le Hub [cite: 26, 40]
  docker-publish:
    # On ne publie que si les tests et le SAST sont passés
    needs: [build-and-test, security-sast]
    # On ne publie que sur la branche main (pas sur les PR)
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build et Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # REMPLACE 'ton-user' PAR TON VRAI PSEUDO DOCKER HUB
          tags: ${{ secrets.DOCKER_USERNAME }}/devops-project:latest
