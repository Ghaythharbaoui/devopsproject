name: CI/CD Complete Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # --- ÉTAPE 1 : BUILD & TEST ---
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Basic Health Check
        run: node -e "console.log('Syntaxe du code OK')"

  # --- ÉTAPE 2 : UNIT TESTS ---
  unit-tests:
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Run Unit Tests
        run: npm test

  # --- ÉTAPE 3 : SÉCURITÉ SAST (CodeQL) ---
  security-sast:
    needs: [build-and-test, unit-tests]
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # --- ÉTAPE 3 : SÉCURITÉ DAST (OWASP ZAP) ---
  security-dast:
    needs: [build-and-test, unit-tests]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install & Start App (Debug Mode)
        run: |
          npm install
          
          # Lancement de l'app en redirigeant les logs vers un fichier pour debug
          echo "Démarrage du serveur..."
          npm start > server.log 2>&1 &
          PID=$!
          
          # On attend 10s pour voir si ça crash tout de suite
          sleep 10
          
          # Vérification si le processus est mort
          if ! ps -p $PID > /dev/null; then
            echo "❌ ERREUR FATALE : L'application a planté au démarrage !"
            echo "--- LOGS DU SERVEUR ---"
            cat server.log
            exit 1
          fi
          
          echo "✅ L'application tourne. Vérification de l'accès au port 3000..."
          
          # 'tcp:3000' est plus fiable que 'http' pour vérifier l'ouverture du port
          npx wait-on tcp:3000 --timeout 60000

      # Si l'étape précédente échoue, on affiche les logs pour comprendre pourquoi
      - name: Show Server Logs on Failure
        if: failure()
        run: |
          echo "=== LOGS DE L'APPLICATION ==="
          cat server.log || echo "Pas de logs trouvés."

      - name: Run OWASP ZAP Scan
        run: |
          # Utilisation de l'image 'zaproxy' et de l'option '-u 0' (root)
          docker run --network host -u 0 \
            -v $(pwd):/zap/wrk/:rw \
            -t zaproxy/zap-stable zap-baseline.py \
            -t http://localhost:3000 \
            -r zap_report.html \
            -I

      - name: Upload ZAP Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-security-report
          path: zap_report.html

  # --- ÉTAPE 5 : DOCKER BUILD & PUSH ---
  docker-publish:
    needs: [build-and-test, unit-tests, security-sast, security-dast]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ghaythharbaoui
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghaythharbaoui/backe-end:latest